#!/usr/bin/env xonsh
import git, os, sys
currentDir = os.getcwd()
for line in $(yadm --help).split("\n"):
    if "yadm's Git repository" in line:
        yadmRepoDir = os.path.expandvars(line.split()[0].strip())

# Adapted From:
# Answer: https://stackoverflow.com/a/957978/10827766
# User: https://stackoverflow.com/users/10738/baudtack
yadmRootDir = $(git -C @(yadmRepoDir) rev-parse --show-toplevel).strip()

if len(sys.argv) > 1:
    command = sys.argv[1]
else:
    command = "yadm" if yadmRootDir == currentDir else "git"
repoDir = yadmRepoDir if command == "yadm" else currentDir
repo = git.Repo(repoDir)
repo.remotes.origin.pull()
with repo.config_reader() as reader:
    for submodule in repo.submodules:
        if not os.path.exists(os.path.join(currentDir, submodule.path)):
            git -C @(currentDir) submodule add --depth 1 @(submodule.url) @(submodule.path)
