#!/usr/bin/env bash
gys () {
    $1 submodule sync;
    $1 submodule foreach 'git -C $toplevel/$sm_path pull || :';
    $1 submodule foreach 'git -C $toplevel/$sm_path stash || :';
    $1 submodule update --force --init --depth 1 --recursive --remote;

    # Adapted From:
    # Answer: https://stackoverflow.com/a/1315213/10827766
    # User: https://stackoverflow.com/users/41861/adrian-pronk
    $1 submodule foreach 'GIT_TOPLEVEL=$toplevel GIT_SM_PATH=$sm_path unset toplevel && unset sm_path && git -C $GIT_TOPLEVEL/$GIT_SM_PATH submodule foreach '\''git -C $toplevel/$sm_path add . || :'\'' || :';
    $1 submodule foreach 'GIT_TOPLEVEL=$toplevel GIT_SM_PATH=$sm_path unset toplevel && unset sm_path && git -C $GIT_TOPLEVEL/$GIT_SM_PATH submodule foreach '\''git -C $toplevel/$sm_path cnm || :'\'' || :';

    $1 submodule foreach 'git -C $toplevel/$sm_path add . || :';
    $1 submodule foreach 'git -C $toplevel/$sm_path cnm || :';
    $1 submodule foreach 'git -C $toplevel/$sm_path stash branch $(git wtt) || :';
}
if [[ -n "$1" ]]; then
    if [[ "$1" == "yadm" ]]; then yadm keybase; fi
    gys $1
else gys "git" || gys "yadm"; fi
